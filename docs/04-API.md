# API Documentation

## Overview

RESTful API for managing geospatial data points. Built with FastAPI.

**Base URL:** `http://localhost:8000`

**API Documentation:** `http://localhost:8000/docs` (Interactive Swagger UI)

**Current Version:** 1.0.0 (Phase 1 - In-Memory Storage)

---

## Quick Start

### Running the Server
```bash
cd backend
./run.sh
```

Server starts at: `http://localhost:8000`

Interactive docs: `http://localhost:8000/docs`

---

## Authentication

**Current:** None (Phase 1)

**Future:** JWT token-based authentication (Phase 3)

---

## Endpoints

### Health Check

Check if the API is running.
```
GET /health
```

**Response:**
```json
{
  "status": "healthy"
}
```

---

### List All Points

Get all data points.
```
GET /api/points
```

**Response:** `200 OK`
```json
[
  {
    "id": "abc123",
    "name": "Amsterdam Sample",
    "description": "Sample data point in Amsterdam",
    "type": "soil",
    "coordinates": [4.9041, 52.3676],
    "depth": 12.5,
    "value": 65.3,
    "createdAt": "2025-02-16T10:30:00"
  },
  ...
]
```

**Example:**
```bash
curl http://localhost:8000/api/points
```

---

### Get Single Point

Get a specific data point by ID.
```
GET /api/points/{point_id}
```

**Path Parameters:**
- `point_id` (string, required) - The point ID

**Response:** `200 OK`
```json
{
  "id": "abc123",
  "name": "Amsterdam Sample",
  "description": "Sample data point in Amsterdam",
  "type": "soil",
  "coordinates": [4.9041, 52.3676],
  "depth": 12.5,
  "value": 65.3,
  "createdAt": "2025-02-16T10:30:00"
}
```

**Error Response:** `404 Not Found`
```json
{
  "detail": "Point with id abc123 not found"
}
```

**Example:**
```bash
curl http://localhost:8000/api/points/abc123
```

---

### Create Point

Create a new data point.
```
POST /api/points
```

**Request Body:**
```json
{
  "name": "Utrecht Sample",
  "description": "New data point in Utrecht",
  "type": "water",
  "coordinates": [5.1214, 52.0907],
  "depth": 15.5,
  "value": 82.3
}
```

**Field Validations:**
- `name`: string, 1-100 characters (required)
- `description`: string, max 500 characters (required)
- `type`: "soil" | "water" | "mineral" | "anomaly" (required)
- `coordinates`: [longitude, latitude], both floats (required)
- `depth`: float, ≥ 0 (required)
- `value`: float, 0-100 (required)

**Response:** `201 Created`
```json
{
  "id": "def456",
  "name": "Utrecht Sample",
  "description": "New data point in Utrecht",
  "type": "water",
  "coordinates": [5.1214, 52.0907],
  "depth": 15.5,
  "value": 82.3,
  "createdAt": "2025-02-16T11:15:00"
}
```

**Error Response:** `422 Validation Error`
```json
{
  "detail": [
    {
      "type": "string_too_short",
      "loc": ["body", "name"],
      "msg": "String should have at least 1 character"
    }
  ]
}
```

**Example:**
```bash
curl -X POST http://localhost:8000/api/points \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Utrecht Sample",
    "description": "New data point in Utrecht",
    "type": "water",
    "coordinates": [5.1214, 52.0907],
    "depth": 15.5,
    "value": 82.3
  }'
```

---

### Update Point

Update an existing data point. All fields are optional.
```
PUT /api/points/{point_id}
```

**Path Parameters:**
- `point_id` (string, required) - The point ID

**Request Body:** (all fields optional)
```json
{
  "name": "Updated Name",
  "depth": 20.0
}
```

**Response:** `200 OK`
```json
{
  "id": "abc123",
  "name": "Updated Name",
  "description": "Sample data point in Amsterdam",
  "type": "soil",
  "coordinates": [4.9041, 52.3676],
  "depth": 20.0,
  "value": 65.3,
  "createdAt": "2025-02-16T10:30:00"
}
```

**Error Response:** `404 Not Found`
```json
{
  "detail": "Point with id abc123 not found"
}
```

**Example:**
```bash
curl -X PUT http://localhost:8000/api/points/abc123 \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Updated Name",
    "depth": 20.0
  }'
```

---

### Delete Point

Delete a data point.
```
DELETE /api/points/{point_id}
```

**Path Parameters:**
- `point_id` (string, required) - The point ID

**Response:** `204 No Content`

(Empty response body)

**Error Response:** `404 Not Found`
```json
{
  "detail": "Point with id abc123 not found"
}
```

**Example:**
```bash
curl -X DELETE http://localhost:8000/api/points/abc123
```

---

## Data Types

### DataPoint

Complete data point object (returned by GET, POST, PUT).
```typescript
{
  id: string;              // UUID generated by server
  name: string;            // 1-100 characters
  description: string;     // Max 500 characters
  type: PointType;         // "soil" | "water" | "mineral" | "anomaly"
  coordinates: [number, number];  // [longitude, latitude]
  depth: number;           // Meters below surface, ≥ 0
  value: number;           // Measurement value, 0-100
  createdAt: string;       // ISO 8601 datetime
}
```

### PointType
```typescript
type PointType = "soil" | "water" | "mineral" | "anomaly";
```

### Coordinates

**Important:** Coordinates follow GeoJSON standard: `[longitude, latitude]`
```typescript
coordinates: [number, number]  // [longitude, latitude]

// Examples:
[4.9041, 52.3676]   // Amsterdam
[5.1214, 52.0907]   // Utrecht
[-73.935242, 40.730610]  // New York (negative = West)
```

**Not** the geographic convention of [latitude, longitude]!

---

## Error Handling

### Error Response Format

All errors follow this structure:
```json
{
  "detail": "Error message"
}
```

Or for validation errors:
```json
{
  "detail": [
    {
      "type": "error_type",
      "loc": ["body", "field_name"],
      "msg": "Human-readable message",
      "ctx": { "additional": "context" }
    }
  ]
}
```

### HTTP Status Codes

- `200 OK` - Successful GET, PUT
- `201 Created` - Successful POST
- `204 No Content` - Successful DELETE
- `404 Not Found` - Resource not found
- `422 Unprocessable Entity` - Validation error
- `500 Internal Server Error` - Server error

---

## CORS

CORS is enabled for:
- `http://localhost:5173` (Vite dev server)

**Headers allowed:**
- All methods (GET, POST, PUT, DELETE, OPTIONS)
- All headers
- Credentials allowed

---

## Validation Rules

### Name
- Type: `string`
- Min length: 1
- Max length: 100
- Required: Yes

### Description
- Type: `string`
- Max length: 500
- Required: Yes

### Type
- Type: `PointType`
- Values: `"soil"`, `"water"`, `"mineral"`, `"anomaly"`
- Required: Yes

### Coordinates
- Type: `[number, number]`
- Format: `[longitude, latitude]`
- Range: longitude (-180 to 180), latitude (-90 to 90)
- Required: Yes

### Depth
- Type: `number`
- Constraint: `≥ 0`
- Unit: meters below surface
- Required: Yes

### Value
- Type: `number`
- Constraint: `0 ≤ value ≤ 100`
- Required: Yes

---

## Examples

### Complete Workflow

**1. Create a point:**
```bash
curl -X POST http://localhost:8000/api/points \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test Point",
    "description": "Testing the API",
    "type": "soil",
    "coordinates": [4.9, 52.3],
    "depth": 10.0,
    "value": 50.0
  }'
```

Response includes the new `id`.

**2. Get all points:**
```bash
curl http://localhost:8000/api/points
```

**3. Update the point:**
```bash
curl -X PUT http://localhost:8000/api/points/{id} \
  -H "Content-Type: application/json" \
  -d '{
    "value": 75.0
  }'
```

**4. Delete the point:**
```bash
curl -X DELETE http://localhost:8000/api/points/{id}
```

---

## Testing with Interactive Docs

**FastAPI provides interactive documentation at `/docs`:**

1. Go to `http://localhost:8000/docs`
2. Click on any endpoint
3. Click "Try it out"
4. Fill in the parameters/body
5. Click "Execute"
6. See the response below

**This is the easiest way to test the API!**

---

## Current Limitations (Phase 1)

- **No persistence:** Data is stored in memory and lost on server restart
- **No authentication:** All endpoints are public
- **No pagination:** All points returned at once
- **No filtering:** Cannot filter by type, location, etc.
- **No geospatial queries:** No distance or boundary searches

**These will be addressed in future phases.**

---

## Roadmap

### Phase 2: PostgreSQL + PostGIS
- Real database persistence
- Geospatial queries (distance, within bounds)
- Database migrations (Alembic)

### Phase 3: Advanced Features
- User authentication (JWT)
- Pagination and filtering
- Search functionality
- Batch operations
- Data export (CSV, GeoJSON)

### Phase 4: Production
- Docker deployment
- Rate limiting
- API versioning
- Monitoring and logging

---

## Architecture
```
HTTP Request
    ↓
FastAPI (main.py)
    ↓
Router (points.py) - HTTP handling
    ↓
Schemas (schemas.py) - Validation
    ↓
CRUD (crud.py) - Business logic
    ↓
Database (database.py) - Storage
```

**Separation of Concerns:**
- Routes handle HTTP
- Schemas validate data
- CRUD contains business logic
- Database manages storage

---

## Development

### Running Tests
```bash
# Coming in Phase 2
pytest
```

### Code Structure
```
backend/
├── app/
│   ├── main.py           # FastAPI app + CORS
│   ├── schemas.py        # Pydantic models
│   ├── crud.py           # Business logic
│   ├── database.py       # Storage (in-memory)
│   └── api/
│       └── routes/
│           └── points.py # API endpoints
├── requirements.txt      # Dependencies
└── run.sh               # Startup script
```

---

## Support

**Issues?**
- Check the interactive docs at `/docs`
- Ensure server is running (`./run.sh`)
- Verify CORS settings for your frontend URL

**Questions?**
- See DECISIONS.md for architectural decisions
- Check the code - it's well-commented!
